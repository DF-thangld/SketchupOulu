{% extends "base.html" %}
{% block custom_css %}

{% endblock %}
{% block menu %}
	{% include 'inside_menu.html' %}
{% endblock %}

{% block onload_script %}


{% endblock %}

{% block js_script %}

{% if g.user and g.user.is_admin %}
    function change_base_scenario_status()
    {
        bootbox.confirm("Are you sure you want to change base status of this scenario?", function(result)
        {
            bootbox.hideAll();
            if (result)
            {
                $.ajax({
                    type: "GET",
                    url: "{{ url_for('admin.change_base_scenario_status', scenario_id=scenario.id) }}",
                    dataType: 'json',
                    success: function(data) {
                        if (data.new_status == 0)
                        {
                            $('#base_scenario_button').removeClass('btn-danger');
                            $('#base_scenario_button').addClass('btn-warning');
                            $('#base_scenario_button').html('Promote to base scenario');
                        }
                        else
                        {
                            $('#base_scenario_button').removeClass('btn-warning');
                            $('#base_scenario_button').addClass('btn-danger');
                            $('#base_scenario_button').html('Demote to normal scenario');
                        }
                        show_alert('alert-success', 'Scenario status changed');

                    },
                    error: function(data)
                    {
                        show_alert('alert-danger', data.responseJSON[0]);
                    }
                });
            }
        });
    }
{% endif %}

{% if g.user and (g.user.username==scenario.owner.username or g.user.is_admin()) %}

    function delete_scenario()
    {
        bootbox.confirm("Are you sure you want to delete this scenario?", function(result)
        {
            bootbox.hideAll();
            if (result)
            {
                $.ajax({
                    type: "GET",
                    url: "{{ url_for('sketchup.delete_scenario', scenario_id=scenario.id) }}",
                    dataType: 'json',
                    success: function(data) {
                        show_alert('alert-success', 'Scenario deleted');
                        window.location = '{{ url_for('users.user_scenarios_page', username=scenario.owner.username) }}';

                    },
                    error: function(data)
                    {
                        show_alert('alert-danger', data.responseJSON[0]);
                    }
                });
            }
        });
    }

    function update_scenario()
    {
        $.ajax({
            type: "POST",
            url: "{{ url_for('sketchup.update_scenario', scenario_id=scenario.id) }}",
            data: {'scenario_name': $('#facebox #scenario_name').val(),
                    'is_public': $('#facebox #is_public').prop('checked')?'1':'0'},
            dataType: 'json',
            success: function(data) {
                $('#edit_scenario #scenario_name').val($('#facebox #scenario_name').val());
                $('#edit_scenario #is_public').prop('checked', $('#facebox #is_public').prop('checked'));
                $('#bread_crum_scenario_name').html($('#facebox #scenario_name').val());
                $('#title_scenario_name').html($('#facebox #scenario_name').val());
                $.facebox.close();
                show_alert('alert-success', 'Scenario saved!');
            },
            error: function(data)
            {
                $('#facebox #update_scenario_errors').html('');
                for (i = 0; i < data.responseJSON.length; i++)
                    $('#facebox #update_scenario_errors').append('<div>- ' + data.responseJSON[i] + '</div>');
                $('#facebox #update_scenario_errors').fadeIn('fast');
            }
        });
    }
{% endif %}

{% if g.user %}
    function clone_scenario()
    {
        bootbox.confirm("Are you sure you want to clone this scenario?", function(result)
        {
            bootbox.hideAll();
            if (result)
            {
                $.ajax({
                    type: "GET",
                    url: "{{ url_for('sketchup.clone_scenario', scenario_id=scenario.id) }}",
                    dataType: 'json',
                    success: function(data) {
                        show_alert('alert-success', 'Scenario cloned');
                        window.location = '{{ url_for('sketchup.view_scenario') }}?id=' + data.id;

                    },
                    error: function(data)
                    {
                        show_alert('alert-danger', data.responseJSON[0]);
                    }
                });
            }
        });

    }
{% endif %}

{% endblock %}

{% block main_content %}
<div class="row" style="margin-top: 20px;">

	<div class="col-lg-10 col-centered">
        <ol class = "breadcrumb">
           <li><a href = "{{ url_for('index') }}">Home</a></li>
           <li class = "active"><a href="{{ url_for('users.profile', username=scenario.owner.username) }}">{{ scenario.owner.username }}</a></li>
           <li class = "active"><a href="{{ url_for('users.user_scenarios_page', username=scenario.owner.username) }}">Scenarios</a></li>
           <li class = "active"><a href="{{ url_for('sketchup.view_scenario', id=scenario.id) }}" id="bread_crum_scenario_name">{{ scenario.name }}</a></li>
        </ol>
		<h2 style="font-size: 45px;"><a href="{{ url_for('sketchup.view_scenario', id=scenario.id) }}" id="title_scenario_name">{{ scenario.name }}</a></h2>
            <div style="float:left;">
                <img src="{{ url_for('static', filename='images/profile_pictures/'+scenario.owner.profile_picture) }}" style="max-width:100px;max-height:100px;" class="img-thumbnail" />
            </div>
            <div style="float:left; margin-left:10px;">
                <div>Created by <a href="{{ url_for('users.profile', username=scenario.owner.username) }}">{{ scenario.owner.username }}</a> at {{ scenario.created_time }}</div>
                {% if scenario.last_edited_user %}
                <div>Last edited by <a href="{{ url_for('users.profile', username=scenario.last_edited_user.username) }}">{{ scenario.last_edited_user.username }}</a> at {{ scenario.last_edited_time }}</div>
                {% endif %}
                {% if scenario.is_public==0 %}
                <div style="color:red">The scenario is deactivated</div>
                {% endif %}
                {% if g.user and (g.user.username==scenario.owner.username or g.user.is_admin()) %}
                <div><a href="javascript:void(0);" onclick="$.facebox($('#edit_scenario').html());">Edit settings</a> - <a href="javascript:void(0);" onclick="delete_scenario();">Delete scenario</a></div>
                <div id="edit_scenario" style="display:none">
                    <h1 style="width:100%; border-bottom: 1px solid #bbb;">Edit scenario</h1>
                    <div style="color:red;display:none;" id="update_scenario_errors"></div>
                    <dl class="form">
                        <dt class="input-label">
                            <label autocapitalize="off" autofocus="autofocus" for="name">Scenario name</label>
                        </dt>
                        <dd>
                            <input type="text" id="scenario_name" name="scenario_name" autocapitalize="off" autofocus="autofocus" style="width:100%" value="{{ scenario.name }}">
                        </dd>
                    </dl>
                    <dl class="form">
                        <dt class="input-label">
                            <label autocapitalize="off" for="is_public">Public</label> <input type="checkbox" id="is_public" name="is_public" value="1" {% if scenario.is_public==1 %}checked{% endif %}/>
                        </dt>
                        <dd>

                        </dd>
                    </dl>
                    <div style="float:right;">
                        <button class="btn btn-primary" onclick="update_scenario();">Update</button>
                        <button class="btn" onclick="$.facebox.close();">Cancel</button>
                    </div>
                    <div style="clear:both"></div>

                </div>
                {% endif %}
                <div>
                {% if g.user %}
                <button class="btn btn-primary" onclick="clone_scenario();">Clone this scenario</button>
                    {% if g.user.is_admin() and scenario.is_base_scenario==0 %}
                    <button class="btn btn-warning" onclick="change_base_scenario_status();" id="base_scenario_button">Promote to base scenario</button>
                    {% elif g.user.is_admin() and scenario.is_base_scenario==1 %}
                    <button class="btn btn-danger" onclick="change_base_scenario_status();" id="base_scenario_button">Demote to normal scenario</button>
                    {% endif %}
                {% endif %}
                </div>
            </div>

            <div style="clear:both"></div>
            <input type="hidden" name="addition_information" value="" id="addition_information"/>
			<div style="margin: 0; padding: 0; display: inline">
			</div>
			<dl class="form">
				<dt class="input-label">
					<div style="width:100%;height:500px;border:1px solid black;">
                        Frame for model
                    </div>
				</dt>
				<dd>
                    <div id="scenario_comment_panel" style="margin-top:10px;">
                        <div class="detailBox">
                            <div class="titleBox">
                              <label>Comment Box</label>
                            </div>
                            <div class="commentBox">
                                <input type="hidden" id="comment_type" value="scenario" />
                                <input type="hidden" id="object_id" value="{{ scenario.id }}" />
                                <textarea id="new_comment" style="min-height:30px;width:100%;height:100px;" class="form-control form-group" type="text" placeholder="Your comments" ></textarea>
                                <div class="form-group">
                                    <button class="btn btn-default" onclick="add_comment();">Add</button>
                                </div>
                            </div>
                            <div class="actionBox">
                                <ul class="commentList" id="comment_list">
                                    {% for comment in scenario.comments %}
                                    <li id="comment_{{ comment.id }}">
                                        <div class="commenterImage">
                                            <img style="max-width:50px;max-height:50px;" src="{{ url_for('static', filename='images/profile_pictures/' + comment.owner.profile_picture) }}" />
                                        </div>
                                        <div class="commentText">
                                            <p class="" id="comment_content_{{ comment.id }}">{{ comment.content }}</p>
                                            <span class="date sub-text">By {{ comment.owner.username }} on {{ comment.created_time }}</span>
                                            {% if g.user and (g.user.is_admin() or g.user.username == comment.owner.username or g.user.username == scenario.owner.username) %}
                                            <span class="date sub-text"> (<a href="#" onclick="display_edit_comment_form({{ comment.id }});">Edit</a> - <a href="#" onclick="delete_comment({{ comment.id }});">Delete</a>)</span>
                                            {% endif %}
                                        </div>
                                        {% if g.user and (g.user.is_admin() or g.user.username == comment.owner.username or g.user.username == scenario.owner.username) %}
                                        <div id="edit_comment_panel" style="display:none;">
                                        <textarea id="edit_panel_content_{{ comment.id }}">{{ comment.content }}</textarea>
                                        </div>
                                        {% endif %}

                                    </li>
                                    {% endfor %}
                                </ul>

                            </div>
                        </div>

                    </div>
				</dd>
			</dl>
	</div>
</div>


{% endblock %}